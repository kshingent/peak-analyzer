# peak-analyzer

## Core Algorithm: Topography-Aware Multidimensional Peak Detection

### Why existing peak detection fails beyond 1D

`scipy.signal.find_peaks` は非常に優れた 1 次元ピーク抽出アルゴリズムですが、
**そのロジック自体が 1 次元地形に特化**して設計されています。

1D ではピークは「左右より高い点」として定義できますが、2D 以上では事情がまったく異なります。

既存の 2D ピーク抽出アルゴリズムには、特に次の 2 つの重大な問題があります。

1. **プラトー (plateau) をピークと誤認識する**

   * 同じ高さが広がる領域をピークと誤判定してしまう
2. **ピークの選別ができない**

   * プロミネンスや isolation といった地誌学的特徴量を計算しても、
     それを用いてピークをフィルタリングする機構が存在しない

これらはすべて、「ピークを点として扱っている」ことに起因します。

PeakAnalyzer はこれを根本から見直し、

> **ピークを “点” ではなく “地形構造 (topographic region)” として扱う**

ことで、多次元データに適用可能なピーク抽出を実現します。

---

### PeakAnalyzer が抽出する地誌学的特徴

PeakAnalyzer は単なるピーク位置検出ではなく、ピークの地形的性質を定量化します。

* peak 座標
* 高さ (height)
* プロミネンス (prominence)
* ピーク面積 (area)
* sharpness
* isolation
* 距離 (distance to higher peak)
* など

これらの特徴により、「検出」ではなく **意味のあるピークの選別** が可能になります。

---

### Plateau を正しく扱うことがすべての出発点

多くの 2D アルゴリズムが失敗する最大の理由は
**プラトーを正しく扱えていない**ことです。

PeakAnalyzer では、まずピークを「点」ではなく「同じ高さを持つ領域」として扱います。

#### Plateau 判定手順

1. 最大値フィルタを適用
2. 得られた同一高さ領域（高さ h）を膨張処理
3. 膨張後の領域に高さ h のセルが存在しない場合、
   その領域は **真の peak plateau** と判定

この処理が欠けているために、多くの 2D 手法ではプラトー内部に誤ったピークが生成されます。

---

### Prominence の計算（地誌学的定義に忠実）

Prominence は以下のように定義されます。

1. peak 領域から **高さ優先の近傍探索** を開始
2. 自身より高い地点に到達するまで探索
3. 探索済み領域内の最低地点の高さを `h_base` とする
4. `prominence = h - h_base`

これは 1D の find_peaks と同じ定義ですが、
PeakAnalyzer はこれを **多次元空間で厳密に実装**します。

---

### 2つの計算戦略（データ地形に応じて選択可能）

PeakAnalyzer では、peak 座標・prominence の計算方法を 2 通り実装しています。

データの「地形」によって適切な戦略が異なります。

#### ① 独立計算方式（Plateau → Prominence）

* Plateau を先に厳密に確定
* その後、各 peak ごとに prominence を個別計算
* 起伏が激しく、ピークが孤立しているデータに適する

#### ② 一括計算方式（Heap による高さ優先探索）

* ヒープキューを用いた高さ優先探索
* 既探索領域の近傍から探索することで、
  プラトー内部に誤ピークを生成しない
* なだらかな地形・広いプラトーが多いデータに適する

この「探索順序の設計」こそが、多次元ピーク抽出の核心です。

---

### Lazy Evaluation による特徴量の遅延計算

`find_peaks` ではフィルタリング前にすべての特徴量を計算します。
しかし実際には、

> フィルタリングに使わない特徴を計算することは時間の無駄

です。

PeakAnalyzer ではこれを解決するために **LazyDataFrame** を実装しています。

* 特徴量は **要求されたときにのみ** 計算される
* フィルタリング条件に必要な特徴が存在しなければ、自動計算
* ユーザーが特徴にアクセスした際も同様に自動計算

これにより、

> **ピーク検出 = 必要な特徴だけを計算する動的プロセス**

となり、大規模データに対して高い計算効率を実現します。

---

### 設計思想のまとめ

PeakAnalyzer は以下の原則に基づいて設計されています。

1. ピークを点ではなく **地形構造** として扱う
2. Plateau を厳密に扱う
3. Prominence を地誌学的定義そのままで多次元に拡張
4. 探索順序を設計することで誤ピークを防ぐ
5. 特徴量計算を遅延評価し、計算コストを最小化する

これにより、PeakAnalyzer は

> **次元に依存しない、地形に基づくピーク抽出アルゴリズム**

を実現しています。
