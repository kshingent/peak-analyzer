# コアアルゴリズム: 地形学的多次元ピーク検出

_← [メインREADMEに戻る](../../README_japanese.md) | [English Version](algorithm.md) →_

## 高次元における1Dロジックの限界

`scipy.signal.find_peaks` は非常に優れた 1 次元ピーク抽出アルゴリズムですが、そのロジック自体が 1 次元地形に特化して設計されています。

1D ではピークは「左右より高い点」として定義できますが、2D 以上では事情がまったく異なります。

既存の 2D ピーク抽出アルゴリズムには、特に次の 2 つの重大な問題があります。

1. **プラトー (plateau) をピークと誤認識する**
   * 同じ高さが広がる領域をピークと誤判定してしまう
2. **ピークの選別ができない**
   * プロミネンスや isolation といった地誌学的特徴量を計算しても、それを用いてピークをフィルタリングする機構が存在しない

これらはすべて、「ピークを点として扱っている」ことに起因します。

PeakAnalyzer はこれを根本から見直し、

> **ピークを "点" ではなく "地形構造 (topographic region)" として扱う**

ことで、多次元データに適用可能なピーク抽出を実現します。

---

## 抽出される地形学的特徴

PeakAnalyzer は単なるピーク位置検出ではなく、ピークの地形的性質を定量化します。

* **ピーク座標**: ピーク領域の重心または代表点
* **高さ**: ピークでの絶対値
* **プロミネンス**: ピークとその最低等高線との垂直距離
* **面積**: ピーク領域の空間的範囲
* **鋭さ**: 局所曲率または高度変化率
* **アイソレーション**: 最も近い高いピークまでの距離
* **距離**: 検出された特徴間の空間関係メトリック

### ピクセルスケールと距離メトリック

* **ピクセルスケールパラメータ**: 各次元の実世界スケールを指定可能（例：`scale=[1.0, 0.5]` でx/y解像度の違いを設定）
* **ミンコフスキー距離**: 距離計算ではパラメータ `p` でミンコフスキー距離メトリックを設定可能（p=1: マンハッタン、p=2: ユークリッド、p=∞: チェビシェフ）
* **距離スケール**: スケールパラメータにより物理単位が保持され、正確な実世界距離測定を保証
* **相対高度 (rel_height)**: prominence_baseとpeak_heightの間の相対高度比でピーク幅（面積）を定義

### 座標系アーキテクチャ

**インデックス空間と座標空間の分離**

PeakAnalyzerは2つの空間表現を明確に区別して管理します：

* **インデックス空間 (i,j,...)**: 計算効率のための内部データ配列インデックス
  - 用途: アルゴリズム処理、メモリアクセス、接続性解析
  - 形式: データ配列次元に対応する整数インデックス
  - 例: `peak_indices = (127, 89)` （2次元配列アクセス用）

* **座標空間 (x,y,...)**: ユーザー操作のための実世界物理座標（存在する場合）
  - 用途: ユーザー入出力、可視化、空間解析、フィルタリング
  - 形式: 物理単位を持つ浮動小数点座標
  - 例: `peak_coordinates = (-120.5, 36.2)` （経度/緯度）、データ値 = 1450.0（任意の物理単位）

**物理的意味と実世界単位**
* **距離・面積計算**: すべての測定が実際の物理単位で計算される
* **異方性解像度対応**: 各軸で異なるスケール設定可能（`scale=[1.0, 1.0, 0.5]`）
* **単位保持**: 解析パイプライン全体で一貫した物理単位を維持
* **スケール考慮特徴**: 幾何学的特性が実世界の寸法を尊重

**空間解析機能**
* **GIS互換操作**: 座標ベースのフィルタリング、バッファリング、空間クエリ
* **地理的統合**: 地理座標系のネイティブサポート
* **マルチスケール解析**: 異なる解像度データのシームレス処理
* **投影サポート**: 柔軟な座標系変換

**可視化とユーザーインターフェース原則**
* **ユーザー中心座標**: すべてのユーザー操作を直感的なxyz...座標空間で実行
* **実世界可視化**: プロットと表示は適切な単位を持つ物理座標を使用
* **インデックス抽象化**: 内部ijk...インデックスをユーザーインターフェースから隠蔽
* **直感的フィルタリング**: 空間フィルターが意味のある座標範囲で動作

これらの特徴により、「検出」ではなく **意味のあるピークの選別** が可能になります。

---

## 厳密なプラトー処理

多くの 2D アルゴリズムが失敗する最大の理由は **プラトーを正しく扱えていない** ことです。

PeakAnalyzer では、まずピークを「点」ではなく「同じ高さを持つ領域」として扱います。

### プラトー検出手順

1. **最大フィルタリング**: データセットに局所最大フィルタを適用
2. **膨張処理**: 識別された一定高度領域に形態学的膨張を実行
3. **検証**: 膨張境界に同じ高度のセルが存在しない場合、その領域を **真のピークプラトー** として分類

この処理が欠けているために、多くの 2D 手法ではプラトー内部に誤ったピークが生成されます。

---

## プロミネンス計算

PeakAnalyzer はプロミネンスの地形学的定義に厳密に従い、それを多次元空間に拡張します：

1. ピーク領域から高度優先近傍探索を開始
2. 現在のピークより高い値を持つ点に遭遇するまで探索を続行
3. この探索中に到達した最低標高をprominence_baseと定義
4. プロミネンスを計算: `prominence = peak_height - prominence_base`

### ウィンドウ長 (wlen) パラメータ

`wlen` パラメータはプロミネンス計算を指定距離内に制限します：
* `wlen` が指定されると、ピークから指定距離を超える点でプロミネンス計算が停止
* これにより解析領域を完全データセットのウィンドウ化サブセットとして扱う
* 特定の空間スケール内でのローカルプロミネンスに焦点を当てる際に有用

### 最高標高の場合のプロミネンス処理

大域的に最高であるピーク（より高いピークが存在しない）の場合：
* **大域最大規則**: プロミネンスはデータ境界の最低点との高度差に等しい
* **境界条件**: 無限境界を使用する場合、プロミネンス計算は実際のデータエッジまで追跡

### 仮想ピーク作成による同高度接続ピーク処理

同じ標高を持ち地形的に接続している複数のピークが存在する場合：
* **任意の標高での接続同高度ピーク**:
  - 同じ高さ`h`の複数のピークA、Bが存在し、高さ≥`h`の地形を通じて接続している場合
  - **ステップ1**: 高さ≥`h`の地形を介して接続した同じ標高`h`のすべてのピークを検出
  - **ステップ2**: 接続した同高度ピークA、B間の鞍点を発見
  - **ステップ3**: 個別ピークAとBのprominence_baseを接続する鞍点の高さに設定
  - **ステップ4**: 高さ`h`のすべての接続ピークを包含する仮想ピークを作成
  - **ステップ5**: より高い高さ`h' > h`の地形が仮想ピークグループ内のいずれかのピークに鞍点を介して接続する場合、仮想ピークのprominence_baseをその鞍点の高さに設定
  - **ステップ6**: 仮想ピークのプロミネンス = `h - より高い地形への鞍点高度`
  - **ステップ7**: より高い地形が存在しない場合、境界ベースのプロミネンス計算を使用
  - このアプローチにより、接続ピークが存在する任意の標高レベルで一貫したプロミネンス計算を保証

経路探索ロジックを通じて実装することで、アルゴリズムは次元に依存しません。

---

## 計算戦略

ライブラリは、データの「地形」に応じて2つの戦略を提供します：

| 戦略 | ロジック | 最適な使用ケース |
| --- | --- | --- |
| **独立計算** | 最初にすべてのプラトーを識別し、次に各々について個別にプロミネンスを計算 | 高コントラストで孤立した鋭いピークを持つデータ |
| **バッチヒープ探索** | ヒープ優先キューを使用して高度順に地形を探索 | 滑らかな地形または広範囲で複雑なプラトー構造を持つデータ |

---

## 遅延評価による効率性

すべての潜在的ピークに対してすべての地形学的特徴を計算することは、計算コストが高くなります。PeakAnalyzer は性能を最適化するため、**LazyDataFrame** アプローチを利用します。

* **オンデマンド計算**: 特徴は明示的に要求されるか、フィルタリング操作に必要な場合にのみ計算される
* **動的プロセス**: ユーザーが `prominence > 0.5` でフィルタリングする場合、アルゴリズムはプロミネンスのみを計算。その後 `area` フィルタが追加されれば、残りの候補に対して面積を計算
* **メモリ効率**: 最終的に破棄されるピークに対する大きな特徴行列の維持オーバーヘッドを防ぐ

---

## 設計原則

1. **地形学的焦点**: ピークを次元のない点ではなく、領域として扱う
2. **厳密なプラトーロジック**: 平坦な表面がアーティファクトの生成なしに処理されることを保証
3. **地形学的精度**: 1Dプロミネンス定義を簡略化なしにN次元に拡張
4. **最適化された探索**: ヒープ優先構造を利用して次元間の論理的一貫性を維持
5. **計算経済性**: 大規模データセットでの不要な計算を最小化するため遅延評価を使用
6. **座標系分離**: 内部処理用インデックス空間(ijk...)とユーザー操作用座標空間(xyz...)の明確な区別を維持
7. **物理的意味優先**: すべてのユーザー向け測定と可視化で実世界単位と座標を使用
8. **異方性互換**: 次元間での異なる解像度とスケールのネイティブサポート
9. **空間解析統合**: GIS的な座標ベース解析とフィルタリング機能を有効化

---

_詳細なソフトウェアアーキテクチャ情報については、[アーキテクチャドキュメント](../architecture/architecture_ja.md)を参照してください。_

_実装の詳細については、[実装詳細](implementation_details_ja.md)を参照してください。_

_API仕様については、[APIリファレンス](../api/api_reference_ja.md)を参照してください。_